<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<!--NewPage-->
<HTML>
<HEAD>
<!-- Generated by javadoc (build 1.6.0_21) on Mon Sep 20 22:29:36 CEST 2010 -->
<TITLE>
Card_protocol
</TITLE>

<META NAME="date" CONTENT="2010-09-20">

<LINK REL ="stylesheet" TYPE="text/css" HREF="../../../stylesheet.css" TITLE="Style">

<SCRIPT type="text/javascript">
function windowTitle()
{
    if (location.href.indexOf('is-external=true') == -1) {
        parent.document.title="Card_protocol";
    }
}
</SCRIPT>
<NOSCRIPT>
</NOSCRIPT>

</HEAD>

<BODY BGCOLOR="white" onload="windowTitle();">
<HR>


<!-- ========= START OF TOP NAVBAR ======= -->
<A NAME="navbar_top"><!-- --></A>
<A HREF="#skip-navbar_top" title="Skip navigation links"></A>
<TABLE BORDER="0" WIDTH="100%" CELLPADDING="1" CELLSPACING="0" SUMMARY="">
<TR>
<TD COLSPAN=2 BGCOLOR="#EEEEFF" CLASS="NavBarCell1">
<A NAME="navbar_top_firstrow"><!-- --></A>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="3" SUMMARY="">
  <TR ALIGN="center" VALIGN="top">
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../overview-summary.html"><FONT CLASS="NavBarFont1"><B>Overview</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="package-summary.html"><FONT CLASS="NavBarFont1"><B>Package</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#FFFFFF" CLASS="NavBarCell1Rev"> &nbsp;<FONT CLASS="NavBarFont1Rev"><B>Class</B></FONT>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="class-use/Card_protocol.html"><FONT CLASS="NavBarFont1"><B>Use</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="package-tree.html"><FONT CLASS="NavBarFont1"><B>Tree</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../deprecated-list.html"><FONT CLASS="NavBarFont1"><B>Deprecated</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../index-all.html"><FONT CLASS="NavBarFont1"><B>Index</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../help-doc.html"><FONT CLASS="NavBarFont1"><B>Help</B></FONT></A>&nbsp;</TD>
  </TR>
</TABLE>
</TD>
<TD ALIGN="right" VALIGN="top" ROWSPAN=3><EM>
</EM>
</TD>
</TR>

<TR>
<TD BGCOLOR="white" CLASS="NavBarCell2"><FONT SIZE="-2">
&nbsp;<A HREF="../../../ds/ov2/util/Bool_option.html" title="class in ds.ov2.util"><B>PREV CLASS</B></A>&nbsp;
&nbsp;<A HREF="../../../ds/ov2/util/Card_terminal.html" title="class in ds.ov2.util"><B>NEXT CLASS</B></A></FONT></TD>
<TD BGCOLOR="white" CLASS="NavBarCell2"><FONT SIZE="-2">
  <A HREF="../../../index.html?ds/ov2/util/Card_protocol.html" target="_top"><B>FRAMES</B></A>  &nbsp;
&nbsp;<A HREF="Card_protocol.html" target="_top"><B>NO FRAMES</B></A>  &nbsp;
&nbsp;<SCRIPT type="text/javascript">
  <!--
  if(window==top) {
    document.writeln('<A HREF="../../../allclasses-noframe.html"><B>All Classes</B></A>');
  }
  //-->
</SCRIPT>
<NOSCRIPT>
  <A HREF="../../../allclasses-noframe.html"><B>All Classes</B></A>
</NOSCRIPT>


</FONT></TD>
</TR>
<TR>
<TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
  SUMMARY:&nbsp;NESTED&nbsp;|&nbsp;<A HREF="#field_summary">FIELD</A>&nbsp;|&nbsp;<A HREF="#constructor_summary">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_summary">METHOD</A></FONT></TD>
<TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
DETAIL:&nbsp;<A HREF="#field_detail">FIELD</A>&nbsp;|&nbsp;<A HREF="#constructor_detail">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_detail">METHOD</A></FONT></TD>
</TR>
</TABLE>
<A NAME="skip-navbar_top"></A>
<!-- ========= END OF TOP NAVBAR ========= -->

<HR>
<!-- ======== START OF CLASS DATA ======== -->
<H2>
<FONT SIZE="-1">
ds.ov2.util</FONT>
<BR>
Class Card_protocol</H2>
<PRE>
<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">java.lang.Object</A>
  <IMG SRC="../../../resources/inherit.gif" ALT="extended by "><B>ds.ov2.util.Card_protocol</B>
</PRE>
<HR>
<DL>
<DT><PRE>public class <B>Card_protocol</B><DT>extends <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</A></DL>
</PRE>

<P>
Applet side of the OV-chip protocol implementation. This class is
 the heart of the OV-chip protocol on the card. Every applet should
 contain precisely one instance of this class. Under normal
 circumstances the user does not have to care about it, because this
 instance is created, maintained and used in <A HREF="../../../ds/ov2/util/Protocol_applet.html" title="class in ds.ov2.util"><CODE>Protocol_applet</CODE></A>, see <A HREF="../../../ds/ov2/util/Protocol_applet.html#card_protocol"><CODE>Protocol_applet.card_protocol</CODE></A>.
 <P>

 The singleton instance in <A HREF="../../../ds/ov2/util/Protocol_applet.html#card_protocol"><CODE>Protocol_applet.card_protocol</CODE></A>
 processes all incomming APDU's with <A HREF="../../../ds/ov2/util/Card_protocol.html#process(javacard.framework.APDU, byte[])"><CODE>process</CODE></A>. First
 it will be checked if the protocol identification, the step number
 and the batch meet the expectations. Then, for argument APDU's the
 data is transfered to the declared arguments of the current
 protocol step. If all arguments have been received the method of
 the current step is called. Finally the results are transfered back
 to the host with response APDU's.
 <P>

 So this class implements all protocol-layer related features,
 execpt for managing the registered protocols (see <A HREF="../../../ds/ov2/util/Registered_protocols.html" title="class in ds.ov2.util"><CODE>Registered_protocols</CODE></A>) and selecting new protocols (see <A HREF="../../../ds/ov2/util/Protocol_applet.html#process(javacard.framework.APDU)"><CODE>Protocol_applet.process</CODE></A> and <A HREF="../../../ds/ov2/util/Registered_protocols.html#get_protocol(short)"><CODE>Registered_protocols.get_protocol</CODE></A>). 
 <P>

 The singleton instance in <A HREF="../../../ds/ov2/util/Protocol_applet.html#card_protocol"><CODE>Protocol_applet.card_protocol</CODE></A>
 keeps the current protocol and the current step in its local state.
 Additionally it remembers where to continue with argument
 deserialization or result serialization for the next APDU. All this
 internal state is updated appropriately when processing APDU's.
 <P>

 The implementation is just a matter of interpreting the data
 structures of the protocols and protocol steps. No big surprises
 here, it is only a bit cumbersome because Java Card 2.2.1 only
 guarantees an APDU buffer size of 32 bytes.
<P>

<P>
<DL>
<DT><B>CPP Preprocessing</B></DT>
  <DD>This class uses the following cpp defines:
   <a href="../../../overview-summary.html#PACKAGE">PACKAGE</a>,
   <a href="../../../overview-summary.html#PUBLIC">PUBLIC</a>,
   <a href="../../../overview-summary.html#ASSERT">ASSERT</a>,
   <a href="../../../overview-summary.html#ASSERT_TAG">ASSERT_TAG<a></DD>
<DT><B>Execution Environment:</B></DT>
  <DD>card</DD>
<DT><B>Author:</B></DT>
  <DD>Hendrik Tews</DD>
<DT><B>Version:</B></DT>
  <DD>$Revision: 1.13 $</DD>
<DT><B>Last Commit:</B></DT>
  <DD>$Date: 2009-04-09 10:42:16 $ by $Author: tews $</DD>
</DL>
<HR>

<P>
<!-- =========== FIELD SUMMARY =========== -->

<A NAME="field_summary"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="2"><FONT SIZE="+2">
<B>Field Summary</B></FONT></TH>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;byte</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#batch">batch</A></B></CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The batch number.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;short</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#data_index">data_index</A></B></CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The number of bytes of the current argument or result that have
 already been received or sent.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;<A HREF="../../../ds/ov2/util/Protocol.html" title="class in ds.ov2.util">Protocol</A></CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#protocol">protocol</A></B></CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The current protocol or null if no protocol is selected.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;short</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#protocol_step">protocol_step</A></B></CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The number of the current protocol step.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;short</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#total_still_to_send">total_still_to_send</A></B></CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Total number of result bytes still to send.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;short</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#variable_index">variable_index</A></B></CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;The index of the argument or result that we are currentely
 working on.</TD>
</TR>
</TABLE>
&nbsp;
<!-- ======== CONSTRUCTOR SUMMARY ======== -->

<A NAME="constructor_summary"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="2"><FONT SIZE="+2">
<B>Constructor Summary</B></FONT></TH>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#Card_protocol()">Card_protocol</A></B>()</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Constructor.</TD>
</TR>
</TABLE>
&nbsp;
<!-- ========== METHOD SUMMARY =========== -->

<A NAME="method_summary"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="2"><FONT SIZE="+2">
<B>Method Summary</B></FONT></TH>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>&nbsp;void</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#clear_protocol()">clear_protocol</A></B>()</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Clears the current protocol selection.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;void</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#finish_step()">finish_step</A></B>()</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Finish current protocol step.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;void</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#process_method(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)">process_method</A></B>(<A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/APDU.html?is-external=true" title="class or interface in javacard.framework">APDU</A>&nbsp;apdu,
               byte[]&nbsp;buf,
               <A HREF="../../../ds/ov2/util/Protocol_step.html" title="class in ds.ov2.util">Protocol_step</A>&nbsp;step)</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Call the method for the current step and start sending the
 results afterwards.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;void</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#process_receive(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)">process_receive</A></B>(<A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/APDU.html?is-external=true" title="class or interface in javacard.framework">APDU</A>&nbsp;apdu,
                byte[]&nbsp;buf,
                <A HREF="../../../ds/ov2/util/Protocol_step.html" title="class in ds.ov2.util">Protocol_step</A>&nbsp;step)</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process the next argument APDU.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>private &nbsp;void</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#process_send(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)">process_send</A></B>(<A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/APDU.html?is-external=true" title="class or interface in javacard.framework">APDU</A>&nbsp;apdu,
             byte[]&nbsp;buf,
             <A HREF="../../../ds/ov2/util/Protocol_step.html" title="class in ds.ov2.util">Protocol_step</A>&nbsp;step)</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Start or continue to send the results to the host.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>&nbsp;void</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#process(javacard.framework.APDU, byte[])">process</A></B>(<A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/APDU.html?is-external=true" title="class or interface in javacard.framework">APDU</A>&nbsp;apdu,
        byte[]&nbsp;buf)</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Process the next APDU in the currently selected protocol.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>&nbsp;boolean</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#protocol_running()">protocol_running</A></B>()</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Returns true if a protocol is selected.</TD>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD ALIGN="right" VALIGN="top" WIDTH="1%"><FONT SIZE="-1">
<CODE>&nbsp;void</CODE></FONT></TD>
<TD><CODE><B><A HREF="../../../ds/ov2/util/Card_protocol.html#set_protocol(ds.ov2.util.Protocol)">set_protocol</A></B>(<A HREF="../../../ds/ov2/util/Protocol.html" title="class in ds.ov2.util">Protocol</A>&nbsp;protocol)</CODE>

<BR>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Set the next selected protocol.</TD>
</TR>
</TABLE>
&nbsp;<A NAME="methods_inherited_from_class_java.lang.Object"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#EEEEFF" CLASS="TableSubHeadingColor">
<TH ALIGN="left"><B>Methods inherited from class java.lang.<A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true" title="class or interface in java.lang">Object</A></B></TH>
</TR>
<TR BGCOLOR="white" CLASS="TableRowColor">
<TD><CODE><A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#clone()" title="class or interface in java.lang">clone</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#equals(java.lang.Object)" title="class or interface in java.lang">equals</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#finalize()" title="class or interface in java.lang">finalize</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#getClass()" title="class or interface in java.lang">getClass</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#hashCode()" title="class or interface in java.lang">hashCode</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#notify()" title="class or interface in java.lang">notify</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#notifyAll()" title="class or interface in java.lang">notifyAll</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#toString()" title="class or interface in java.lang">toString</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#wait()" title="class or interface in java.lang">wait</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#wait(long)" title="class or interface in java.lang">wait</A>, <A HREF="http://java.sun.com/javase/6/docs/api/java/lang/Object.html?is-external=true#wait(long, int)" title="class or interface in java.lang">wait</A></CODE></TD>
</TR>
</TABLE>
&nbsp;
<P>

<!-- ============ FIELD DETAIL =========== -->

<A NAME="field_detail"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="1"><FONT SIZE="+2">
<B>Field Detail</B></FONT></TH>
</TR>
</TABLE>

<A NAME="protocol"><!-- --></A><H3>
protocol</H3>
<PRE>
private <A HREF="../../../ds/ov2/util/Protocol.html" title="class in ds.ov2.util">Protocol</A> <B>protocol</B></PRE>
<DL>
<DD>The current protocol or null if no protocol is selected. Reset
 to null after the last result APDU of the last step of a
 protocol. Then the outside has to set the next current protocol
 with <A HREF="../../../ds/ov2/util/Card_protocol.html#set_protocol(ds.ov2.util.Protocol)"><CODE>set_protocol</CODE></A>. Normally this is done
 automatically in <A HREF="../../../ds/ov2/util/Protocol_applet.html#process(javacard.framework.APDU)"><CODE>Protocol_applet.process</CODE></A>. <P>

 The INS byte of the next incoming APDU must be equal to the
 protocol identification of this protocol.
<P>
<DL>
</DL>
</DL>
<HR>

<A NAME="protocol_step"><!-- --></A><H3>
protocol_step</H3>
<PRE>
private short <B>protocol_step</B></PRE>
<DL>
<DD>The number of the current protocol step. Automatically
 increased after each step.
 <P>

 The P1 byte of the next incoming APDU must be equal to this
 number.
<P>
<DL>
</DL>
</DL>
<HR>

<A NAME="variable_index"><!-- --></A><H3>
variable_index</H3>
<PRE>
private short <B>variable_index</B></PRE>
<DL>
<DD>The index of the argument or result that we are currentely
 working on. If the <A HREF="../../../ds/ov2/util/Card_protocol.html#batch"><CODE>batch</CODE></A> is positive it is an index of
 an argument in the array of declared arguments of the current
 step. If the <A HREF="../../../ds/ov2/util/Card_protocol.html#batch"><CODE>batch</CODE></A> is negative it is an index of a
 result in the array of declared results or the current step.
<P>
<DL>
</DL>
</DL>
<HR>

<A NAME="data_index"><!-- --></A><H3>
data_index</H3>
<PRE>
private short <B>data_index</B></PRE>
<DL>
<DD>The number of bytes of the current argument or result that have
 already been received or sent.
<P>
<DL>
</DL>
</DL>
<HR>

<A NAME="batch"><!-- --></A><H3>
batch</H3>
<PRE>
private byte <B>batch</B></PRE>
<DL>
<DD>The batch number. The batch counts the APDU's in one step. For
 argument APDU's the first bit is 0 and the batch counts the
 argument APDU's from 0 upwards. For result APDU's the first bit
 is 1 and the batch counts from -128 upwards. The first response
 is sent in the response APDU of the last argument APDU,
 therefore the first result APDU has batch -127. 
 <P>

 The P2 byte of the next incomming APDU must be equal to the
 batch.
<P>
<DL>
</DL>
</DL>
<HR>

<A NAME="total_still_to_send"><!-- --></A><H3>
total_still_to_send</H3>
<PRE>
private short <B>total_still_to_send</B></PRE>
<DL>
<DD>Total number of result bytes still to send. Used for checking
 the response length (LE byte) of the result APDU's. Not used
 when receiving arguments.
<P>
<DL>
</DL>
</DL>

<!-- ========= CONSTRUCTOR DETAIL ======== -->

<A NAME="constructor_detail"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="1"><FONT SIZE="+2">
<B>Constructor Detail</B></FONT></TH>
</TR>
</TABLE>

<A NAME="Card_protocol()"><!-- --></A><H3>
Card_protocol</H3>
<PRE>
<B>Card_protocol</B>()</PRE>
<DL>
<DD>Constructor. There is only one instance of this class necessary
 in each applet. This is automatically created and maintained in
 <A HREF="../../../ds/ov2/util/Protocol_applet.html" title="class in ds.ov2.util"><CODE>Protocol_applet</CODE></A>. This constructor does not initialize
 anything. Initialization happens in <A HREF="../../../ds/ov2/util/Card_protocol.html#set_protocol(ds.ov2.util.Protocol)"><CODE>set_protocol</CODE></A>.
<P>
</DL>

<!-- ============ METHOD DETAIL ========== -->

<A NAME="method_detail"><!-- --></A>
<TABLE BORDER="1" WIDTH="100%" CELLPADDING="3" CELLSPACING="0" SUMMARY="">
<TR BGCOLOR="#CCCCFF" CLASS="TableHeadingColor">
<TH ALIGN="left" COLSPAN="1"><FONT SIZE="+2">
<B>Method Detail</B></FONT></TH>
</TR>
</TABLE>

<A NAME="protocol_running()"><!-- --></A><H3>
protocol_running</H3>
<PRE>
public boolean <B>protocol_running</B>()</PRE>
<DL>
<DD>Returns true if a protocol is selected.
<P>
<DD><DL>

<DT><B>Returns:</B><DD>true if a protocol is currently selected.</DL>
</DD>
</DL>
<HR>

<A NAME="set_protocol(ds.ov2.util.Protocol)"><!-- --></A><H3>
set_protocol</H3>
<PRE>
public void <B>set_protocol</B>(<A HREF="../../../ds/ov2/util/Protocol.html" title="class in ds.ov2.util">Protocol</A>&nbsp;protocol)</PRE>
<DL>
<DD>Set the next selected protocol. (Re-)Initialize the local state
 to prepare for the first APDU of this protocol.
<P>
<DD><DL>
<DT><B>Parameters:</B><DD><CODE>protocol</CODE> - next selected protocol</DL>
</DD>
</DL>
<HR>

<A NAME="clear_protocol()"><!-- --></A><H3>
clear_protocol</H3>
<PRE>
public void <B>clear_protocol</B>()</PRE>
<DL>
<DD>Clears the current protocol selection. Afterwards no protocol
 is selected.
<P>
<DD><DL>
</DL>
</DD>
</DL>
<HR>

<A NAME="finish_step()"><!-- --></A><H3>
finish_step</H3>
<PRE>
private void <B>finish_step</B>()</PRE>
<DL>
<DD>Finish current protocol step. Called as the last action in the
 last result APDU. Advances <A HREF="../../../ds/ov2/util/Card_protocol.html#protocol_step"><CODE>protocol_step</CODE></A> and
 initializes the local state for the next step (set <A HREF="../../../ds/ov2/util/Card_protocol.html#variable_index"><CODE>variable_index</CODE></A>, <A HREF="../../../ds/ov2/util/Card_protocol.html#data_index"><CODE>data_index</CODE></A> and <A HREF="../../../ds/ov2/util/Card_protocol.html#batch"><CODE>batch</CODE></A> all to
 0). If the last step of a protocol is finished the current
 protocol selection is cleared.
<P>
<DD><DL>
</DL>
</DD>
</DL>
<HR>

<A NAME="process_send(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)"><!-- --></A><H3>
process_send</H3>
<PRE>
private void <B>process_send</B>(<A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/APDU.html?is-external=true" title="class or interface in javacard.framework">APDU</A>&nbsp;apdu,
                          byte[]&nbsp;buf,
                          <A HREF="../../../ds/ov2/util/Protocol_step.html" title="class in ds.ov2.util">Protocol_step</A>&nbsp;step)</PRE>
<DL>
<DD>Start or continue to send the results to the host. This method
 is called in the last argument APDU, just after the step method
 has finished, and afterwards for all result APDU that follow. 
 <P>

 This method serializes the declared results of the current
 step, advances <A HREF="../../../ds/ov2/util/Card_protocol.html#data_index"><CODE>data_index</CODE></A>, <A HREF="../../../ds/ov2/util/Card_protocol.html#variable_index"><CODE>variable_index</CODE></A>,
 <A HREF="../../../ds/ov2/util/Card_protocol.html#total_still_to_send"><CODE>total_still_to_send</CODE></A> and <A HREF="../../../ds/ov2/util/Card_protocol.html#batch"><CODE>batch</CODE></A> as needed and
 sends the serialized data to the host. After the last result
 byte has been sent the current step is finished with <A HREF="../../../ds/ov2/util/Card_protocol.html#finish_step()"><CODE>finish_step()</CODE></A>. 
 <P>

 This method checks the expected response length (the LE byte)
 as far as this is possible. An <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework"><CODE>ISOException</CODE></A> is thrown
 for wrong values.
<P>
<DD><DL>
<DT><B>Parameters:</B><DD><CODE>apdu</CODE> - the incoming APDU<DD><CODE>buf</CODE> - the APDU buffer, must be equal to <code>apdu.getBuffer()</code>.<DD><CODE>step</CODE> - the current protocol step, must be equal to <code>protocol.steps[protocol_step]</code>
<DT><B>Throws:</B>
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISO7816.html?is-external=true#SW_CORRECT_LENGTH_00" title="class or interface in javacard.framework"><CODE>SW_CORRECT_LENGTH_00</CODE></A> if the
 expected response length (the LE byte) is too small</DL>
</DD>
</DL>
<HR>

<A NAME="process_method(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)"><!-- --></A><H3>
process_method</H3>
<PRE>
private void <B>process_method</B>(<A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/APDU.html?is-external=true" title="class or interface in javacard.framework">APDU</A>&nbsp;apdu,
                            byte[]&nbsp;buf,
                            <A HREF="../../../ds/ov2/util/Protocol_step.html" title="class in ds.ov2.util">Protocol_step</A>&nbsp;step)</PRE>
<DL>
<DD>Call the method for the current step and start sending the
 results afterwards. This method only calls the step method and
 prepares the local state for sending the results (<A HREF="../../../ds/ov2/util/Card_protocol.html#variable_index"><CODE>variable_index</CODE></A> and <A HREF="../../../ds/ov2/util/Card_protocol.html#data_index"><CODE>data_index</CODE></A> are reset to 0, <A HREF="../../../ds/ov2/util/Card_protocol.html#batch"><CODE>batch</CODE></A> is set to 0x80 and <A HREF="../../../ds/ov2/util/Card_protocol.html#total_still_to_send"><CODE>total_still_to_send</CODE></A> is
 initialized to the total size of the declared results). Sending
 the first results is then done by <A HREF="../../../ds/ov2/util/Card_protocol.html#process_send(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)"><CODE>process_send</CODE></A>.
<P>
<DD><DL>
<DT><B>Parameters:</B><DD><CODE>apdu</CODE> - the incoming APDU<DD><CODE>buf</CODE> - the APDU buffer, must be equal to <code>apdu.getBuffer()</code>.<DD><CODE>step</CODE> - the current protocol step, must be equal to <code>protocol.steps[protocol_step]</code>
<DT><B>Throws:</B>
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISO7816.html?is-external=true#SW_CORRECT_LENGTH_00" title="class or interface in javacard.framework"><CODE>SW_CORRECT_LENGTH_00</CODE></A> if the
 expected response length (the LE byte) of the last argument
 APDU is too small</DL>
</DD>
</DL>
<HR>

<A NAME="process_receive(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)"><!-- --></A><H3>
process_receive</H3>
<PRE>
private void <B>process_receive</B>(<A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/APDU.html?is-external=true" title="class or interface in javacard.framework">APDU</A>&nbsp;apdu,
                             byte[]&nbsp;buf,
                             <A HREF="../../../ds/ov2/util/Protocol_step.html" title="class in ds.ov2.util">Protocol_step</A>&nbsp;step)</PRE>
<DL>
<DD>Process the next argument APDU. If there are still arguments to
 receive then deserialize the data of this APDU into the
 declared arguments. Divert to <A HREF="../../../ds/ov2/util/Card_protocol.html#process_method(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)"><CODE>process_method</CODE></A> after all arguments have been received. Advance
 <A HREF="../../../ds/ov2/util/Card_protocol.html#variable_index"><CODE>variable_index</CODE></A>, <A HREF="../../../ds/ov2/util/Card_protocol.html#data_index"><CODE>data_index</CODE></A> and <A HREF="../../../ds/ov2/util/Card_protocol.html#batch"><CODE>batch</CODE></A>
 as needed. <P>

 Checks that the host does not send too much data. Throw an
 <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework"><CODE>ISOException</CODE></A> otherwise. (If the host sends too little
 data than the next incomming APDU will yield a batch mismatch error.)
<P>
<DD><DL>
<DT><B>Parameters:</B><DD><CODE>apdu</CODE> - the incoming APDU<DD><CODE>buf</CODE> - the APDU buffer, must be equal to <code>apdu.getBuffer()</code>.<DD><CODE>step</CODE> - the current protocol step, must be equal to <code>protocol.steps[protocol_step]</code>
<DT><B>Throws:</B>
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISO7816.html?is-external=true#SW_BYTES_REMAINING_00" title="class or interface in javacard.framework"><CODE>SW_BYTES_REMAINING_00</CODE></A> if the
 host has sent too much data
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISO7816.html?is-external=true#SW_CORRECT_LENGTH_00" title="class or interface in javacard.framework"><CODE>SW_CORRECT_LENGTH_00</CODE></A> if the
 expected response length (the LE byte) of the last argument
 APDU is too small</DL>
</DD>
</DL>
<HR>

<A NAME="process(javacard.framework.APDU, byte[])"><!-- --></A><H3>
process</H3>
<PRE>
public void <B>process</B>(<A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/APDU.html?is-external=true" title="class or interface in javacard.framework">APDU</A>&nbsp;apdu,
                    byte[]&nbsp;buf)</PRE>
<DL>
<DD>Process the next APDU in the currently selected protocol. This
 method checks it the protocol identification number, the step
 number and the batch in the incoming APDU match our local state. If
 one of these checks fails an <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework"><CODE>ISOException</CODE></A> is thrown
 with an appropriate response status. 
 <P>

 Depending on the <A HREF="../../../ds/ov2/util/Card_protocol.html#batch"><CODE>batch</CODE></A> the APDU is delegated to either
 <A HREF="../../../ds/ov2/util/Card_protocol.html#process_receive(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)"><CODE>process_receive</CODE></A> or <A HREF="../../../ds/ov2/util/Card_protocol.html#process_send(javacard.framework.APDU, byte[], ds.ov2.util.Protocol_step)"><CODE>process_send</CODE></A>. <P>

 Asserts that a current protocol is selected.
 <P>

 In case of any error the protocol selection is cleared and the
 current protocol aborted.
<P>
<DD><DL>
<DT><B>Parameters:</B><DD><CODE>apdu</CODE> - the incoming APDU<DD><CODE>buf</CODE> - the APDU buffer, must be equal to <code>apdu.getBuffer()</code>.
<DT><B>Throws:</B>
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="../../../ds/ov2/util/Response_status.html#OV_UNEXPECTED_PROTOCOL_ID"><CODE>OV_UNEXPECTED_PROTOCOL_ID</CODE></A> for a protocol identification number
 mismatch
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="../../../ds/ov2/util/Response_status.html#OV_UNEXPECTED_PROTOCOL_STEP"><CODE>OV_UNEXPECTED_PROTOCOL_STEP</CODE></A> for a protocol step number mismatch
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="../../../ds/ov2/util/Response_status.html#OV_UNEXPECTED_BATCH"><CODE>OV_UNEXPECTED_BATCH</CODE></A> for a
 batch mismatch
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISO7816.html?is-external=true#SW_BYTES_REMAINING_00" title="class or interface in javacard.framework"><CODE>SW_BYTES_REMAINING_00</CODE></A> if the
 host has sent too much data
<DD><CODE><A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISOException.html?is-external=true" title="class or interface in javacard.framework">ISOException</A></CODE> - with status <A HREF="http://www.cs.ru.nl/~woj/javacardapi221/javacard/framework/ISO7816.html?is-external=true#SW_CORRECT_LENGTH_00" title="class or interface in javacard.framework"><CODE>SW_CORRECT_LENGTH_00</CODE></A> if the
 expected response length (the LE byte) of the last argument
 APDU or an result APDU is too small</DL>
</DD>
</DL>
<!-- ========= END OF CLASS DATA ========= -->
<HR>


<!-- ======= START OF BOTTOM NAVBAR ====== -->
<A NAME="navbar_bottom"><!-- --></A>
<A HREF="#skip-navbar_bottom" title="Skip navigation links"></A>
<TABLE BORDER="0" WIDTH="100%" CELLPADDING="1" CELLSPACING="0" SUMMARY="">
<TR>
<TD COLSPAN=2 BGCOLOR="#EEEEFF" CLASS="NavBarCell1">
<A NAME="navbar_bottom_firstrow"><!-- --></A>
<TABLE BORDER="0" CELLPADDING="0" CELLSPACING="3" SUMMARY="">
  <TR ALIGN="center" VALIGN="top">
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../overview-summary.html"><FONT CLASS="NavBarFont1"><B>Overview</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="package-summary.html"><FONT CLASS="NavBarFont1"><B>Package</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#FFFFFF" CLASS="NavBarCell1Rev"> &nbsp;<FONT CLASS="NavBarFont1Rev"><B>Class</B></FONT>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="class-use/Card_protocol.html"><FONT CLASS="NavBarFont1"><B>Use</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="package-tree.html"><FONT CLASS="NavBarFont1"><B>Tree</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../deprecated-list.html"><FONT CLASS="NavBarFont1"><B>Deprecated</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../index-all.html"><FONT CLASS="NavBarFont1"><B>Index</B></FONT></A>&nbsp;</TD>
  <TD BGCOLOR="#EEEEFF" CLASS="NavBarCell1">    <A HREF="../../../help-doc.html"><FONT CLASS="NavBarFont1"><B>Help</B></FONT></A>&nbsp;</TD>
  </TR>
</TABLE>
</TD>
<TD ALIGN="right" VALIGN="top" ROWSPAN=3><EM>
</EM>
</TD>
</TR>

<TR>
<TD BGCOLOR="white" CLASS="NavBarCell2"><FONT SIZE="-2">
&nbsp;<A HREF="../../../ds/ov2/util/Bool_option.html" title="class in ds.ov2.util"><B>PREV CLASS</B></A>&nbsp;
&nbsp;<A HREF="../../../ds/ov2/util/Card_terminal.html" title="class in ds.ov2.util"><B>NEXT CLASS</B></A></FONT></TD>
<TD BGCOLOR="white" CLASS="NavBarCell2"><FONT SIZE="-2">
  <A HREF="../../../index.html?ds/ov2/util/Card_protocol.html" target="_top"><B>FRAMES</B></A>  &nbsp;
&nbsp;<A HREF="Card_protocol.html" target="_top"><B>NO FRAMES</B></A>  &nbsp;
&nbsp;<SCRIPT type="text/javascript">
  <!--
  if(window==top) {
    document.writeln('<A HREF="../../../allclasses-noframe.html"><B>All Classes</B></A>');
  }
  //-->
</SCRIPT>
<NOSCRIPT>
  <A HREF="../../../allclasses-noframe.html"><B>All Classes</B></A>
</NOSCRIPT>


</FONT></TD>
</TR>
<TR>
<TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
  SUMMARY:&nbsp;NESTED&nbsp;|&nbsp;<A HREF="#field_summary">FIELD</A>&nbsp;|&nbsp;<A HREF="#constructor_summary">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_summary">METHOD</A></FONT></TD>
<TD VALIGN="top" CLASS="NavBarCell3"><FONT SIZE="-2">
DETAIL:&nbsp;<A HREF="#field_detail">FIELD</A>&nbsp;|&nbsp;<A HREF="#constructor_detail">CONSTR</A>&nbsp;|&nbsp;<A HREF="#method_detail">METHOD</A></FONT></TD>
</TR>
</TABLE>
<A NAME="skip-navbar_bottom"></A>
<!-- ======== END OF BOTTOM NAVBAR ======= -->

<HR>

</BODY>
</HTML>
